name: CI - Test and Validate

# Trigger this workflow on push to main branch or any pull request
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false  # Continue testing other versions even if one fails
      # Test with multiple Python versions to ensure compatibility
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12', '3.14']
    
    steps:
    # Step 1: Checkout the repository code
    - name: Checkout code
      uses: actions/checkout@v4
    
    # Step 2: Set up Python environment
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'  # Cache pip dependencies for faster builds
    
    # Step 3: Install dependencies
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "✅ Dependencies installed successfully"
    
    # Step 4: Check Python syntax errors
    - name: Check for syntax errors
      run: |
        python -m py_compile googlemain.py
        python -m py_compile tools.py
        echo "✅ No syntax errors found"
    
    # Step 5: Verify imports work correctly
    - name: Test imports
      run: |
        python -c "import tools; print('✅ tools.py imports successfully')"
        echo "✅ All imports validated"
    
    # Step 6: Run basic code validation
    - name: Validate code structure
      run: |
        # Check if main functions exist in tools.py
        python -c "from tools import run_pandas_agent, push_folder_to_github, search_paths; print('✅ Core functions found')"
        echo "✅ Code structure validated"

  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: Checkout code
    - name: Checkout code
      uses: actions/checkout@v4
    
    # Step 2: Set up Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    # Step 3: Install linting tools
    - name: Install linting tools
      run: |
        pip install flake8
        echo "✅ Linting tools installed"
    
    # Step 4: Run flake8 linter (allows warnings, fails on errors only)
    - name: Lint with flake8
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit with warnings (not errors) for style issues
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        echo "✅ Linting completed"
